name: Enshan Forum Auto Checkin

on:
  workflow_dispatch: # 支持手动触发测试
  schedule:
    # 每天北京时间 08:35 运行 (UTC 00:35)，稍微错开整点更安全
    - cron: '35 0 * * *'

jobs:
  checkin:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Environment
        # 即使默认自带，加上这一步可以确保 jq 处于最新状态
        run: sudo apt-get install -y jq curl

      - name: Random Delay
        # 随机延迟 1 到 60 秒，模拟真人行为，对抗简单风控
        run: sleep $(( RANDOM % 60 + 1 ))

      - name: Run Enshan Script
        env:
          # 确保这里的名字和你在 GitHub Settings -> Secrets 里填的一模一样
          ENSHAN_COOKIE: ${{ secrets.ENSHAN_COOKIE }}
          BARK_URL: ${{ secrets.BARK_URL }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_USERID: ${{ secrets.TELEGRAM_USERID }}
        run: |
          # 检查目录是否存在，不存在则报错提醒
          if [ ! -f "./shell/enshan.sh" ]; then
            echo "❌ 错误: 未在 ./shell/ 目录下找到 enshan.sh"
            ls -R
            exit 1
          fi
          bash ./shell/enshan.sh
